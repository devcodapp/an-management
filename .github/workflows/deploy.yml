# This is a basic workflow to help you get started with Actions

name: Deploy to VM

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ develop ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 18

    - name: Set up SSH
      run: echo "$PRIVATE_KEY" > ./id_rsa
      env:
        PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
    
    - name: Install dependencies
      run: sudo npm install

    - name: Build
      run: sudo npm run build

    - name: Copy build to VPS
      run: |
        scp -i ./id_rsa -r ./dist/* ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/apps/back/an-management

    - name: SSH into VPS and Deploy
      run: |
        ssh -i ./id_rsa ${{ secrets.USERNAME }}@${{ secrets.HOST }} "cd /home/apps/back/an-management && sudo pm2 restart dev-management"
    # - name: Deploy using ssh
    #   uses: appleboy/ssh-action@master
      # with:
      #   host: ${{ secrets.HOST }}
      #   username: ${{ secrets.USERNAME }}
      #   key: ${{ secrets.PRIVATE_KEY }}
      #   port: 22
      #   script: |
      #     cd /home/apps/back/an-management
      #     sudo git checkout develop
      #     sudo git pull origin develop
      #     sudo git status
      #     sudo pnpm i
      #     sudo pnpm build
      #     sudo pm2 restart dev-management
